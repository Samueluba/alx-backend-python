#!/bin/bash

# kubctl-0x01 - Scale, verify, load-test, and monitor a Django app in Kubernetes

set -e  # Exit on error

DEPLOYMENT_NAME="messaging-app-deployment"
NAMESPACE="default"

echo "ğŸ”§ Scaling deployment '$DEPLOYMENT_NAME' to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=3 --namespace="$NAMESPACE"

echo "â³ Waiting for pods to be ready..."
sleep 5  # short wait for pods to spin up

echo "ğŸ” Verifying running pods..."
kubectl get pods --namespace="$NAMESPACE" -l app=messaging-app

echo "âœ… Deployment scaled successfully."

# Get ClusterIP Service URL (internal access)
echo "ğŸŒ Getting service details..."
SERVICE_NAME="messaging-app-service"
PORT=$(kubectl get svc "$SERVICE_NAME" --namespace="$NAMESPACE" -o=jsonpath='{.spec.ports[0].port}')
CLUSTER_IP=$(kubectl get svc "$SERVICE_NAME" --namespace="$NAMESPACE" -o=jsonpath='{.spec.clusterIP}')

if [[ -z "$CLUSTER_IP" || -z "$PORT" ]]; then
    echo "âŒ Could not get service IP or port."
    exit 1
fi

TARGET_URL="http://$CLUSTER_IP:$PORT"

echo "ğŸ§ª Performing load testing using wrk (5 seconds, 10 connections, 2 threads)..."
if ! command -v wrk &> /dev/null; then
    echo "âŒ wrk is not installed. Install it to perform load testing:"
    echo "ğŸ‘‰ https://github.com/wg/wrk"
    exit 1
fi

wrk -t2 -c10 -d5s "$TARGET_URL"

echo "ğŸ“Š Monitoring resource usage (CPU/Memory):"
kubectl top pods --namespace="$NAMESPACE"

echo "âœ… Done."

